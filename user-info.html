<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>账户信息</title>
		<link rel="stylesheet" type="text/css" href="css/bin/font-awesome-4.7.0/css/font-awesome.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/bin/mobilereset.css" />
		<link rel="stylesheet" type="text/css" href="css/page.css" />
		<script type="text/javascript" src="js/public.js"></script>
	</head>
	<body>
		<div class="P_L_container">
			<div class="P_L_header">
				<i class="fa fa-angle-left return-pages-btn" aria-hidden="true" onclick="returnPages()"></i>
				账号信息
			</div>
			<section class="L_user_info L_flex_content">
				<ul class="common-ul">
					<li class="li-img">头像<img class="info_header" src="img/user-info-header.png" onclick="galleryImg()"/><i class="fa fa-angle-right nav-right"></i></li>
					<li>用户名<span class='username'>某某某</span><i class="fa fa-angle-right nav-right"></i></li>
				</ul>
				<p class="ul-title">账号绑定</p>
				<ul class="common-ul">
					<li onclick="getTel()"><i class="fa fa-phone" aria-hidden="true"></i>手机<span class="tel">未绑定</span><i class="fa fa-angle-right nav-right"></i></li>
					<li onclick="getServices('weixin')"><i class="fa fa-weixin" aria-hidden="true"></i>微信<span class="no-value weixin">未绑定</span><i class="fa fa-angle-right nav-right"></i></li>
					<li onclick="getServices('qq')"><i class="fa fa-qq" aria-hidden="true"></i>QQ<span class="no-value qq">未绑定</span><i class="fa fa-angle-right nav-right"></i></li>
					<li onclick="getServices('sinaweibo')"><i class="fa fa-weibo" aria-hidden="true"></i>微博<span class="no-value sinaweibo">未设置</span><i class="fa fa-angle-right nav-right"></i></li>
					<li><i class="fa fa-shopping-cart"></i>淘宝<span class="no-value">未设置</span><i class="fa fa-angle-right nav-right"></i></li>
				</ul>
				<p class="ul-title">安全设置</p>
				<ul class="common-ul">
					<li>登录密码<span class="no-value">未设置</span><i class="fa fa-angle-right nav-right"></i></li>
					<li>支付密码<span class="no-value">未设置</span><i class="fa fa-angle-right nav-right"></i></li>
					<li>小额免密支付<i class="fa fa-angle-right nav-right"></i></li>
				</ul>
			</section>
		</div>
		
		<script type="text/javascript" src="js/jquery.js" ></script>
		<script type="text/javascript">
			var Storage = JSON.parse(localStorage.getItem('account'));
			var src =localStorage.getItem('info_header');
			var username = $('.username');
			var tel = $('.tel')
			username.html(Storage.username)
			tel.html(Storage.tel);
			if(src != null){
				 $('.info_header').attr('src',src);	
			}
			var wxName = localStorage.getItem('weixin');
            var qqName = localStorage.getItem('qq');
            var wbName = localStorage.getItem('sinaweibo');
            if(wxName != null){
            	$('.weixin').html(wxName);
            }
            
            if(qqName != null){
            	$('.qq').html(qqName);
            }
            
            if(wbName != null){
            	$('.weibo').html(wbName);
            }
			
            // 登录授权操作
			var auths={};
			document.addEventListener('plusready',plusReady,false);
			function plusReady(){
				plus.oauth.getServices(function(services){
					for(var i in services){
						var service=services[i];
						auths[service.id]=service;
					}
				},function(e){
					alert("获取登录认证失败："+e.message);
				});
			}
            
            
			function getServices(type){
				if(localStorage.getItem(type) != null){
					var typeName='';
					switch (type){
						case 'weixin':
							typeName='微信';
							break;
						case 'qq':
							typeName='QQ';
							break;
						case 'weibo':
							typeName='新浪微博';
							break;
					}
					// 事件处理  
					plus.nativeUI.confirm("是否想要解绑"+typeName, function(event) {  
					    var tapIndex = event.index;  
					    switch (tapIndex) {  
					        case 0 :   
					            logout(auths[type],type);  
					            break;
					    }  
					}, "饿了么", ["是", "否"]);  
					
				}else{
					login(type)
				}
				
			}
			// 登录认证
			function login(id){
				var auth=auths[id];
				console.log(auth);
				if(auth){
					var w=null;
					if(plus.os.name=="Android"){
						w=plus.nativeUI.showWaiting();
					}
					document.addEventListener("pause",function(){
						setTimeout(function(){
							w&&w.close();w=null;
						},2000);
					}, false );
					auth.login(function(){
						w&&w.close();w=null;
//						plus.nativeUI.alert(JSON.stringify(auth.authResult));
						userinfo(auth,id);
					},function(e){
						w&&w.close();w=null;
						plus.nativeUI.alert("绑定失败",null,"登录失败["+e.code+"]："+e.message);
					});
				}else{
					plus.nativeUI.alert("无效的登录认证通道！",null,"登录");
				}
			}
			
              // 从相册中选择图片头像
			function galleryImg(){
			    plus.gallery.pick(function(path){
					localStorage.setItem('info_header',path);
					var src = localStorage.getItem('info_header');
			       $('.info_header').attr('src',src);
			    }, function(e){
			    	}, {filter:'image'});
			}	

			// 获取用户信息
			function userinfo(a,id){
				a.getUserInfo(function(){
					var nickname=a.userInfo.nickname||a.userInfo.name||a.userInfo.miliaoNick;
					plus.nativeUI.alert("欢迎“"+nickname+"”登录！");
					localStorage.setItem(id,nickname)
					$('.'+id+'').html(nickname)
				},function(e){
					plus.nativeUI.alert("获取用户信息失败！",null,"登录");
				});
			}
			
			//注销登录
			function logout(auth,type){
				auth.logout(function(){
					plus.nativeUI.alert("解除绑定\""+auth.description+"\"成功");
					$('.'+type+'').html('未绑定');
					localStorage.removeItem(type);
				},function(e){
					plus.nativeUI.alert("注销\""+auth.description+"\"失败："+e.code);
				});
			}
			
		</script>
		
		
	</body>
</html>
